[![License: MIT](https://img.shields.io/badge/License-MIT-yellow.svg)](https://opensource.org/licenses/MIT)
[![Python 3.10+](https://img.shields.io/badge/python-3.10+-blue.svg)](https://www.python.org/downloads/release/python-3100/)
[![GitHub release (latest by date)](https://img.shields.io/github/v/release/Lucien-6/mask-analyze)](https://github.com/Lucien-6/mask-analyze/releases)

# Mask Analyzer | 掩膜数据分析工具

一个用于分析处理掩膜图像序列的工具，特别适用于生物和微生物图像分析。

## 目录

- [功能特点](#功能特点)
- [系统要求](#系统要求)
- [使用方法](#使用方法)
  - [使用可执行文件（推荐）](#使用可执行文件推荐)
  - [从源码运行](#从源码运行)
- [使用指南](#使用指南)
  - [1. 数据加载](#1-数据加载)
  - [2. 数据分析](#2-数据分析)
  - [3. 掩膜处理](#3-掩膜处理)
  - [4. 图像对比度调整](#4-图像对比度调整)
  - [5. 手动剔除对象](#5-手动剔除对象)
  - [6. 图像预览](#6-图像预览)
  - [7. 数据导出](#7-数据导出)
  - [8. 快捷键](#8-快捷键)
- [打包为可执行文件](#打包为可执行文件)
- [常见问题](#常见问题)
- [许可证](#许可证)

## 功能特点

### 一、原始数据处理

本工具可处理原始图片序列与相应的掩膜图片序列，掩膜图片必须为灰度图。工具会自动将不同灰度值识别为不同对象进行分析处理。

### 二、图像增强优化

- 支持高位深图像（16 位深度或浮点型）的自动增强
- 提供基于直方图调整的图像对比度增强，支持以下参数控制：
  - 下限/上限百分比：通过直方图截断增强图像对比度
  - 亮度/对比度：精细调整图像显示效果
- 基于实时预览的交互式参数调整，直观展示效果变化
- 直方图可视化展示，帮助理解图像数据分布

### 三、数据加载

- 可浏览选择原始图片序列文件夹与掩膜图片序列文件夹
- 可设定需要处理分析的图片序号范围
- 可设定图片序列的拍摄帧率和 μm/pixel 换算系数

### 四、掩膜处理

- 支持膨胀、腐蚀、开运算、闭运算等多种形态学操作
- 支持填补空洞功能
- 支持面积阈值噪点过滤
- 支持剔除被视野边缘截断的掩膜数据
- 支持手动剔除特定对象，适用于处理质量控制
- 支持撤销最近处理和还原初始掩膜功能
- 可选择对单帧或所有帧应用上述操作

### 五、实时预览

- 可实时预览原始图片与掩膜叠加显示
- 可播放、暂停和逐帧浏览图片序列
- 可显示/隐藏对象的边缘轮廓、中心点和长短轴
- 可通过鼠标左键点击查看对象详细信息
- 可通过鼠标右键点击标记并剔除特定对象

### 六、数据分析

- 可分析每个对象的面积、长短轴、纵横比、中心点坐标等数据
- 可生成对象数量-时间曲线图、面积分数-时间曲线图
- 可生成面积分布、长轴分布、短轴分布和纵横比分布直方图
- 在分析计算中会自动跳过被手动剔除的对象
- 采用多线程技术加速大规模图像序列处理

### 七、数据导出

- 可保存导出修改后的掩膜图片序列
- 可导出各种统计图表（包含全局分析图表和每帧分析图表）
- 可导出每帧中的对象详细数据为 Excel 表格

## 系统要求

- Windows 10/11, macOS 10.12+, 或 Linux
- 如使用 Python 源码运行，需要安装以下 Python 库:
  - Python 3.10+
  - PyQt5
  - NumPy
  - OpenCV (opencv-python)
  - Matplotlib
  - Pandas
  - openpyxl
  - scipy

## 使用方法

### 使用可执行文件（推荐）

1. 从[发布页面](https://github.com/Lucien-6/mask-analyze/releases)下载最新版本的可执行文件
2. 直接运行可执行文件，无需安装任何依赖

### 从源码运行

1. 克隆或下载此代码库
2. 安装所需依赖:

```bash
pip install -r requirements.txt
```

或者手动安装:

```bash
pip install numpy opencv-python matplotlib PyQt5 pandas openpyxl scipy
```

3. 运行主程序:

```bash
python main.py
```

## 使用指南

### 1. 数据加载

1. 点击"浏览..."按钮选择原始图片目录和掩膜图片目录
2. 设置需要处理的图片序号范围（默认为全部图片）
3. 设置 μm/pixel 换算系数和拍摄帧率
4. 点击"加载图像"按钮加载数据

### 2. 数据分析

1. 加载图像后，点击"分析计算"按钮开始分析
2. 分析完成后，右侧面板将显示各种统计图表

### 3. 掩膜处理

1. 在左侧"掩膜处理"面板中选择需要的处理操作
2. 设置各种处理操作的参数
3. 选择是否应用于所有帧
4. 点击"应用处理"按钮执行处理
5. 如需撤销操作，可使用"撤销最近处理"按钮
6. 如需还原至原始状态，可使用"还原初始掩膜"按钮

### 4. 图像对比度调整

1. 点击菜单栏中的"视图" → "图像增强" → "调整图像对比度"
2. 在弹出的对话框中可以看到当前帧的预览效果和直方图
3. 使用以下滑块调整参数：
   - **下限百分比**：调整直方图截断的下限（较低值可保留更多暗部细节）
   - **上限百分比**：调整直方图截断的上限（较低值可增强亮部细节）
   - **亮度**：调整整体图像亮度（大于 1 增加亮度，小于 1 降低亮度）
   - **对比度**：调整图像对比度（大于 1 增加对比度，小于 1 降低对比度）
4. 参数调整时，预览区域会实时显示效果变化
5. 直方图上的红线和绿线分别表示下限和上限阈值位置
6. 点击"重置参数"可恢复默认值
7. 完成调整后点击"应用"按钮保存设置并关闭对话框

### 5. 手动剔除对象

1. 使用鼠标右键点击需要剔除的对象
2. 对象中心会出现白色十字标记，表示已选中
3. 右侧"手动剔除对象"列表中会显示被剔除对象的 ID
4. 再次右键点击已标记对象可取消剔除
5. 点击"清空当前帧剔除标记"按钮可移除所有标记
6. 点击"应用处理"按钮后，被剔除的对象将在分析中被忽略

### 6. 图像预览

1. 使用播放按钮开始/停止图片序列的播放
2. 使用上一帧/下一帧按钮手动浏览图片
3. 使用进度条跳转到特定帧
4. 使用"显示/隐藏边缘轮廓"等按钮切换显示模式
5. 鼠标左键点击对象可查看详细信息
6. 鼠标右键点击对象可标记/取消剔除

### 7. 数据导出

1. 点击菜单栏中的"文件" → "导出分析结果"
2. 在弹出的对话框中选择要导出的内容：
   - 修改后的掩膜图片序列
   - 分析结果图表（包含所有全局分析图表和每帧分析图表）
   - 详细数据表格（每帧中所有对象的信息）
3. 选择导出目录
4. 点击"确定"按钮完成导出

### 8. 快捷键

| 快捷键 | 功能      |
| ------ | --------- |
| 空格键 | 播放/暂停 |
| 左箭头 | 上一帧    |
| 右箭头 | 下一帧    |

## 打包为可执行文件

如果需要将程序打包成独立的可执行文件，可以使用提供的打包脚本:

1. 安装 PyInstaller:

```bash
pip install pyinstaller
```

2. 运行打包脚本:

```bash
python build.py
```

3. 打包完成后，可执行文件将位于 `dist` 目录中

## 常见问题

- **问题**: 程序无法启动或加载图像
  **解决方案**: 确保安装了所有必要的依赖，并且提供的图像路径正确

- **问题**: 导出功能失败
  **解决方案**: 确保导出目录有写入权限

- **问题**: 图像显示过暗或过亮
  **解决方案**: 使用"视图" → "图像增强" → "调整图像对比度"功能调整显示效果，或启用"自动增强高位深图像"选项

- **问题**: 分析速度较慢
  **解决方案**: 程序会自动使用多线程加速分析，如果图像序列较大，请耐心等待

## 详细文档

详细的使用说明可通过程序的"帮助"菜单查看。

## 许可证

本仓库遵循 [MIT 许可证](./LICENSE)。

Copyright (c) 2025 Lucien
